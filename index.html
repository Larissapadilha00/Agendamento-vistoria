<script>
    const horarios = ["08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00"];
    let selectedCollaborator = '';
    let selectedDate = '';
    let selectedHour = '';
    const agendamentos = {};

    const apiUrl = "https://script.google.com/macros/s/AKfycbwSmzt8wTuYDF3eTMw57X8Hhu-Ybs6Od5udOBIsqoFZz1q4O1YTDrhcF8ruffYfBhJC/exec";

    function selectCollaborator(nome) {
        selectedCollaborator = nome;
        document.getElementById('collaborators').classList.add('hidden');
        document.getElementById('selector').classList.remove('hidden');
        document.getElementById('selectedCollaborator').innerText = `Agendamento - ${nome}`;
    }

    function showMonth() {
        clearScreens();
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';
        calendar.classList.remove('hidden');
        document.getElementById('backButton').classList.remove('hidden');

        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const grid = document.createElement('div');
        grid.className = 'calendar-grid';

        const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
        for (const day of weekDays) {
            grid.innerHTML += `<div class='header-cell'>${day}</div>`;
        }

        for (let i = 0; i < firstDay; i++) {
            grid.innerHTML += `<div></div>`;
        }

        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}-${month + 1}-${d}`;
            const hasAvailable = horarios.some(h => !agendamentos[`${selectedCollaborator}-${dateStr}-${h}`]);
            const icon = hasAvailable ? '' : '<div class="icon-red">ðŸ”´</div>';
            grid.innerHTML += `<div class='day-card' onclick="openDay('${dateStr}')">${icon}${d}</div>`;
        }

        calendar.appendChild(grid);
    }

    function showWeek() {
        clearScreens();
        const weekView = document.getElementById('weekView');
        weekView.innerHTML = '<h2>Semana Atual</h2>';
        weekView.classList.remove('hidden');
        document.getElementById('backButton').classList.remove('hidden');

        const today = new Date();
        const weekDays = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex'];
        const weekDates = [];

        today.setDate(today.getDate() - today.getDay() + 1);
        for (let i = 0; i < 5; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            const dateStr = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
            weekDates.push({ label: weekDays[i], dateStr });
        }

        const grid = document.createElement('div');
        grid.className = 'week-grid';

        weekDates.forEach(day => {
            const column = document.createElement('div');
            const header = document.createElement('div');
            header.className = 'header-cell';
            header.innerText = day.label;
            column.appendChild(header);

            let available = false;
            horarios.forEach(hora => {
                const key = `${selectedCollaborator}-${day.dateStr}-${hora}`;
                if (!agendamentos[key]) {
                    available = true;
                    const btn = document.createElement('div');
                    btn.className = 'hour';
                    btn.innerText = hora;
                    btn.onclick = () => selectHour(day.dateStr, hora);
                    column.appendChild(btn);
                }
            });

            if (!available) {
                const noAvailable = document.createElement('div');
                noAvailable.className = 'no-available';
                noAvailable.innerHTML = 'ðŸ”´';
                column.appendChild(noAvailable);
            }

            grid.appendChild(column);
        });

        weekView.appendChild(grid);
    }

    function openDay(dateStr) {
        clearScreens();
        const dayHours = document.getElementById('dayHours');
        dayHours.innerHTML = `<h2>HorÃ¡rios do dia ${dateStr}</h2>`;
        let available = false;

        horarios.forEach(hora => {
            const key = `${selectedCollaborator}-${dateStr}-${hora}`;
            if (!agendamentos[key]) {
                available = true;
                const hourBtn = document.createElement('div');
                hourBtn.className = 'hour';
                hourBtn.innerText = hora;
                hourBtn.onclick = () => selectHour(dateStr, hora);
                dayHours.appendChild(hourBtn);
            }
        });

        if (!available) {
            const noAvailable = document.createElement('div');
            noAvailable.className = 'no-available';
            noAvailable.innerText = 'ðŸ”´ Sem horÃ¡rio disponÃ­vel';
            dayHours.appendChild(noAvailable);
        }

        const back = document.createElement('div');
        back.className = 'back-button';
        back.innerHTML = `<button onclick="showMonth()">â¬… Voltar para o CalendÃ¡rio</button>`;
        dayHours.appendChild(back);

        dayHours.classList.remove('hidden');
    }

    function selectHour(date, hour) {
        selectedDate = date;
        selectedHour = hour;
        document.getElementById('form').style.display = 'flex';
    }

    function book() {
        const nome = document.getElementById('nome').value.trim();
        const empreendimento = document.getElementById('empreendimento').value.trim();
        const local = document.getElementById('local').value.trim();

        if (!nome || !empreendimento || !local) {
            alert('Preencha todos os campos!');
            return;
        }

        const key = `${selectedCollaborator}-${selectedDate}-${selectedHour}`;
        agendamentos[key] = { nome, empreendimento, local };

        const data = {
            colaborador: selectedCollaborator,
            data: selectedDate,
            hora: selectedHour,
            nome: nome,
            empreendimento: empreendimento,
            local: local
        };

        fetch(apiUrl + `?colaborador=${encodeURIComponent(data.colaborador)}&data=${encodeURIComponent(data.data)}&hora=${encodeURIComponent(data.hora)}&nome=${encodeURIComponent(data.nome)}&empreendimento=${encodeURIComponent(data.empreendimento)}&local=${encodeURIComponent(data.local)}`, {
            method: 'GET',
        })
        .then(response => response.json())
        .then(result => {
            alert('Agendado com sucesso!');
            clearForm();
        })
        .catch(error => {
            alert('Erro ao salvar no banco de dados.');
            console.error('Erro:', error);
        });

        clearScreens();
        document.getElementById('selector').classList.remove('hidden');
    }

    function clearForm() {
        document.getElementById('form').style.display = 'none';
        document.getElementById('nome').value = '';
        document.getElementById('empreendimento').value = '';
        document.getElementById('local').value = '';
    }

    function goBack() {
        clearScreens();
        document.getElementById('selector').classList.remove('hidden');
        document.getElementById('backButton').classList.add('hidden');
    }

    function clearScreens() {
        document.getElementById('calendar').classList.add('hidden');
        document.getElementById('dayHours').classList.add('hidden');
        document.getElementById('weekView').classList.add('hidden');
        document.getElementById('form').style.display = 'none';
    }
</script>
