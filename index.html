<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistema de Agendamento de Vistorias</title>
    <style>
        :root {
            --verde-principal: rgb(52, 69, 55);
            --verde-claro: rgb(72, 95, 75);
            --branco: 
#f5f5f5;
            --cinza: 
#e0e0e0;
            --vermelho: 
#e74c3c;
            --azul: 
#3498db;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; } /* Added asterisk for global reset */

        body {
          background-color: var(--branco);
          font-family: Arial, sans-serif;
          color: var(--verde-principal);
          padding: 20px;
        }

        .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
          padding: 0 20px;
          flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }

        .header h1 {
            margin-bottom: 10px; /* Adjust margin for h1 in header */
        }

        .nav-buttons {
          display: flex;
          gap: 10px;
        }

        .nav-btn {
          background-color: var(--azul);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          transition: background-color 0.3s;
        }

        .nav-btn:hover {
          background-color: 
#2980b9;
        }

        .nav-btn.active {
          background-color: var(--verde-principal);
        }

        h1, h2 { text-align: center; margin-bottom: 20px; }

        .card-container {
          display: flex;
          justify-content: center;
          gap: 20px;
          flex-wrap: wrap;
        }

        .card {
          background-color: var(--verde-principal);
          color: var(--branco);
          padding: 20px;
          border-radius: 12px;
          cursor: pointer;
          width: 180px;
          text-align: center;
          box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          transition: transform 0.3s;
        }

        .card:hover { transform: scale(1.05); }

        .hidden { display: none !important; } /* Added !important for stronger override */

        .selector, .back-button { margin-top: 20px; text-align: center; }

        .selector button, .back-button button {
          background-color: var(--verde-claro);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          margin: 5px;
        }

        .selector button:hover, .back-button button:hover {
          background-color: var(--verde-principal);
        }

        .calendar-grid {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 10px;
          max-width: 700px; /* Limit calendar width */
          margin: 0 auto; /* Center calendar */
        }

        .header-cell {
          font-weight: bold;
          text-align: center;
          padding: 10px 0;
        }

        .day-card {
          background-color: var(--cinza);
          padding: 15px;
          border-radius: 8px;
          cursor: pointer;
          text-align: center;
          position: relative;
          min-height: 50px; /* Ensure consistent height */
          display: flex; /* For centering content */
          align-items: center; /* For centering content */
          justify-content: center; /* For centering content */
        }

        .day-card:hover {
          background-color: var(--verde-claro);
          color: white;
        }

        .icon-red {
          color: var(--vermelho);
          position: absolute;
          top: 5px;
          right: 5px;
          font-size: 18px;
        }
        
        .day-hours-container { /* Wrapper for day hours for better layout */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .hour {
          background-color: var(--cinza);
          padding: 10px;
          border-radius: 8px;
          cursor: pointer;
          text-align: center;
          margin: 5px;
          min-width: 80px;
        }

        .hour:hover {
          background-color: var(--verde-claro);
          color: white;
        }

        .form {
          margin-top: 20px;
          display: none; /* Initially hidden, controlled by JS */
          flex-direction: column;
          gap: 10px;
          max-width: 400px;
          margin-left: auto;
          margin-right: auto;
          background-color: var(--cinza);
          padding: 20px;
          border-radius: 12px;
        }

        .form input, .form textarea {
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 6px;
          font-family: inherit;
        }

        .form button {
          background-color: var(--verde-principal);
          color: white;
          border: none;
          padding: 10px;
          border-radius: 8px;
          cursor: pointer;
        }

        .form button:hover {
          background-color: var(--verde-claro);
        }
        .form button[type="button"] { /* Style for cancel button */
            background-color: var(--vermelho);
        }
        .form button[type="button"]:hover {
            background-color: #c0392b;
        }


        .no-available {
          color: var(--vermelho);
          text-align: center;
          margin-top: 10px;
          font-style: italic;
        }

        .week-grid {
          display: grid;
          grid-template-columns: repeat(5, 1fr); /* Mon-Fri */
          gap: 10px;
          margin-top: 20px;
          max-width: 800px; /* Limit width */
          margin-left: auto;
          margin-right: auto;
        }

        .week-grid > div { /* Column in week grid */
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--cinza);
        }


        /* Estilos para relatórios */
        .report-container {
          max-width: 1200px;
          margin: 0 auto;
        }

        .filter-section {
          background-color: var(--cinza);
          padding: 20px;
          border-radius: 12px;
          margin-bottom: 20px;
        }

        .filter-row {
          display: flex;
          gap: 15px;
          margin-bottom: 15px;
          flex-wrap: wrap;
          align-items: end;
        }

        .filter-group {
          display: flex;
          flex-direction: column;
          gap: 5px;
        }

        .filter-group label {
          font-weight: bold;
          font-size: 14px;
        }

        .filter-group input, .filter-group select {
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 6px;
          min-width: 150px;
        }

        .export-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin: 20px 0;
        }

        .export-btn {
          background-color: var(--azul);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
        }

        .export-btn:hover {
          background-color: 
#2980b9;
        }

        .table-container {
          overflow-x: auto;
          background-color: white;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table {
          width: 100%;
          border-collapse: collapse;
        }

        th, td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #ddd;
        }

        th {
          background-color: var(--verde-principal);
          color: white;
          font-weight: bold;
          position: sticky; /* Make table headers sticky */
          top: 0;
        }

        tr:hover {
          background-color: 
#f8f9fa;
        }

        .status-badge {
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: bold;
        }

        .status-agendado {
          background-color: 
#e8f5e8;
          color: 
#2d5016;
        }

        .action-btn {
          background-color: var(--vermelho);
          color: white;
          border: none;
          padding: 5px 10px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
        }

        .action-btn:hover {
          background-color: 
#c0392b;
        }

        .stats-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        }

        .stat-card {
          background-color: white;
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
          font-size: 2em;
          font-weight: bold;
          color: var(--verde-principal);
        }

        .stat-label {
          color: #666;
          margin-top: 5px;
        }

        /* NOVO: Estilo para navegação do calendário */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px; /* Adiciona um pouco de padding */
        }
        .calendar-nav h2 {
            margin-bottom: 0; /* Remove margin padrão do h2 para alinhar melhor */
            flex-grow: 1; /* Faz o título ocupar o espaço disponível */
        }
        .calendar-nav button {
            background-color: var(--verde-claro);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .calendar-nav button:hover {
            background-color: var(--verde-principal);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sistema de Agendamento de Vistorias</h1>
        <div class="nav-buttons">
            <button class="nav-btn active" id="btn-agendar" onclick="showSection('agendamento')">Agendar</button>
            <button class="nav-btn" id="btn-relatorios" onclick="showSection('relatorios')">Relatórios</button>
        </div>
    </div>

    <!-- Seção de Agendamento -->
    <div id="section-agendamento">
        <div class="card-container" id="collaborators">
            <div class="card" onclick="selectCollaborator('Cleber')">Cleber</div>
            <div class="card" onclick="selectCollaborator('Devilson')">Devilson</div>
        </div>

        <div class="selector hidden" id="selector">
            <h2 id="selectedCollaborator"></h2>
            <button onclick="triggerShowMonth()">Mês</button> <!-- MODIFICADO: para inicializar o mês/ano -->
            <button onclick="showWeek()">Semana</button>
        </div>

        <div class="back-button hidden" id="backButton">
            <button onclick="goBack()">⬅ Voltar</button>
        </div>

        <div class="calendar hidden" id="calendar">
            <!-- Calendário Mês será gerado aqui -->
        </div>

        <div class="day-hours hidden" id="dayHours">
             <!-- Horários do Dia serão gerados aqui -->
        </div>
        
        <div class="week-view hidden" id="weekView">
            <!-- Visualização Semanal será gerada aqui -->
        </div>

        <div class="form" id="form">
            <h3>Detalhes do Agendamento</h3>
            <input type="text" id="nome" placeholder="Nome do responsável *" required>
            <input type="text" id="empreendimento" placeholder="Empreendimento *" required>
            <input type="text" id="local" placeholder="Local (Ex: Ap 101) *" required>
            <input type="tel" id="telefone" placeholder="Telefone">
            <textarea id="observacoes" placeholder="Observações (opcional)" rows="3"></textarea>
            <button onclick="book()">Agendar</button>
            <button type="button" onclick="cancelForm()">Cancelar</button>
        </div>
    </div>

    <!-- Seção de Relatórios -->
    <div id="section-relatorios" class="hidden">
        <div class="report-container">
            <div class="filter-section">
                <h3>Filtros</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filter-colaborador">Colaborador:</label>
                        <select id="filter-colaborador">
                            <option value="">Todos</option>
                            <option value="Cleber">Cleber</option>
                            <option value="Devilson">Devilson</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-data-inicio">Data Inicial:</label>
                        <input type="date" id="filter-data-inicio">
                    </div>
                    <div class="filter-group">
                        <label for="filter-data-fim">Data Final:</label>
                        <input type="date" id="filter-data-fim">
                    </div>
                    <div class="filter-group">
                        <label for="filter-empreendimento">Empreendimento:</label>
                        <input type="text" id="filter-empreendimento" placeholder="Filtrar por empreendimento">
                    </div>
                    <div class="filter-group">
                        <label> </label> <!-- Espaçador -->
                        <button class="nav-btn" onclick="applyFilters()">Filtrar</button>
                    </div>
                </div>
            </div>

            <div class="stats-container" id="stats-container">
                <!-- Estatísticas serão inseridas aqui -->
            </div>

            <div class="export-buttons">
                <button class="export-btn" onclick="exportToCSV()">Exportar CSV</button>
                <button class="export-btn" onclick="exportToPDF()">Exportar PDF</button>
                <button class="export-btn" style="background-color: var(--vermelho);" onclick="clearAllData()">Limpar Todos os Dados</button>
            </div>

            <div class="table-container">
                <table id="reports-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Horário</th>
                            <th>Colaborador</th>
                            <th>Responsável</th>
                            <th>Empreendimento</th>
                            <th>Local</th>
                            <th>Telefone</th>
                            <th>Observações</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="reports-tbody">
                        <!-- Dados serão inseridos aqui -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
const horarios = ["08:00", "09:00", "10:00", "11:00", "13:00", "14:00", "15:00", "16:00", "17:00"];
let currentAgendamentos = {}; 
let selectedCollaborator = '';
let selectedDate = ''; 
let selectedHour = '';

const STORAGE_KEY = 'vistoriasAgendamentos';

// NOVO: Variáveis para controlar o mês/ano exibido no calendário
let displayedYear;
let displayedMonth; // 0-11 (Janeiro-Dezembro)


// --- DataManager START ---
class DataManager {
    static async getAgendamentos() {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : {};
    }

    static async saveAgendamentos(agendamentos) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(agendamentos));
        currentAgendamentos = agendamentos; 
    }

    static async addAgendamento(key, data) {
        const agendamentos = await this.getAgendamentos();
        agendamentos[key] = {
            ...data,
            dataAgendamentoISO: new Date().toISOString() 
        };
        await this.saveAgendamentos(agendamentos);
    }

    static async removeAgendamento(key) {
        const agendamentos = await this.getAgendamentos();
        delete agendamentos[key];
        await this.saveAgendamentos(agendamentos);
    }

    static async getAllAgendamentosArray() {
        const agendamentos = await this.getAgendamentos();
        const result = [];
        for (const [key, data] of Object.entries(agendamentos)) {
            const [colaborador, date_str, horario] = key.split('_'); 
            result.push({
                key,
                colaborador,
                data: date_str, 
                horario,
                ...data
            });
        }
        return result.sort((a, b) => {
            const dateA = new Date(`${a.data}T${a.horario}`);
            const dateB = new Date(`${b.data}T${b.horario}`);
            return dateA - dateB;
        });
    }
}
// --- DataManager END ---

async function initializeApp() {
    currentAgendamentos = await DataManager.getAgendamentos();
    const today = new Date();
    const dataInicioFilter = document.getElementById('filter-data-inicio');
    const dataFimFilter = document.getElementById('filter-data-fim');
    if (!dataInicioFilter.value) dataInicioFilter.value = today.toISOString().split('T')[0];
    if (!dataFimFilter.value) dataFimFilter.value = today.toISOString().split('T')[0];
    
    // NOVO: Inicializa o mês/ano de exibição com o mês/ano atual
    displayedYear = today.getFullYear();
    displayedMonth = today.getMonth();

    showSection('agendamento'); 
}

async function showSection(section) {
    document.getElementById('section-agendamento').classList.add('hidden');
    document.getElementById('section-relatorios').classList.add('hidden');
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

    const targetSectionId = `section-${section}`;
    const targetButtonId = `btn-${section === 'agendamento' ? 'agendar' : 'relatorios'}`;

    document.getElementById(targetSectionId).classList.remove('hidden');
    document.getElementById(targetButtonId).classList.add('active');

    if (section === 'relatorios') {
        await loadReports();
    } else {
        resetAgendamentoView();
    }
}

function resetAgendamentoView() {
    clearScreensAndForm();
    document.getElementById('collaborators').classList.remove('hidden');
    document.getElementById('selector').classList.add('hidden');
    document.getElementById('backButton').classList.add('hidden');
    selectedCollaborator = '';
    selectedDate = '';
    selectedHour = '';
    // NOVO: Reseta o mês/ano de exibição para o atual ao trocar de colaborador
    const today = new Date();
    displayedYear = today.getFullYear();
    displayedMonth = today.getMonth();
}

function selectCollaborator(nome) {
    selectedCollaborator = nome;
    document.getElementById('collaborators').classList.add('hidden');
    document.getElementById('selector').classList.remove('hidden');
    document.getElementById('selectedCollaborator').innerText = `Agendar para: ${nome}`;
    document.getElementById('backButton').classList.remove('hidden'); 
    
    // NOVO: Reseta o mês/ano de exibição para o atual ao selecionar um novo colaborador
    const today = new Date();
    displayedYear = today.getFullYear();
    displayedMonth = today.getMonth();
}

function goBack() { 
    const form = document.getElementById('form');
    const dayHours = document.getElementById('dayHours');
    const calendar = document.getElementById('calendar');
    const weekView = document.getElementById('weekView');
    const selector = document.getElementById('selector');

    if (form.style.display === 'flex') { 
        cancelForm();
        // Não é mais necessário reabrir a view anterior aqui, pois cancelForm já cuida disso.
    } else if (!dayHours.classList.contains('hidden')) { 
        showMonth(); // MODIFICADO: Volta para o mês que estava sendo exibido
    } else if (!calendar.classList.contains('hidden') || !weekView.classList.contains('hidden')) { 
        clearScreensAndForm();
        selector.classList.remove('hidden');
        document.getElementById('backButton').classList.remove('hidden'); 
    } else if (!selector.classList.contains('hidden')) { 
        resetAgendamentoView();
    }
}

// NOVO: Função para inicializar e mostrar o calendário mensal
function triggerShowMonth() {
    // Esta função é chamada pelo botão "Mês"
    // Garante que displayedYear e displayedMonth estejam configurados para o mês atual se ainda não estiverem.
    const today = new Date();
    if (typeof displayedYear === 'undefined' || typeof displayedMonth === 'undefined') {
        displayedYear = today.getFullYear();
        displayedMonth = today.getMonth();
    }
    showMonth();
}


// MODIFICADO: showMonth agora usa displayedYear e displayedMonth
function showMonth() {
    clearScreensAndForm();
    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = ''; // Limpa conteúdo anterior
    calendarEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const dateForMonth = new Date(displayedYear, displayedMonth, 1);
    const monthName = dateForMonth.toLocaleString('pt-BR', { month: 'long' });
    const year = displayedYear;

    // NOVO: Criação da barra de navegação do calendário
    const navDiv = document.createElement('div');
    navDiv.className = 'calendar-nav';

    const prevButton = document.createElement('button');
    prevButton.innerText = '< Anterior';
    prevButton.onclick = () => changeMonthDisplay(-1);

    const monthTitle = document.createElement('h2');
    monthTitle.innerText = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} / ${year}`;

    const nextButton = document.createElement('button');
    nextButton.innerText = 'Próximo >';
    nextButton.onclick = () => changeMonthDisplay(1);

    navDiv.appendChild(prevButton);
    navDiv.appendChild(monthTitle);
    navDiv.appendChild(nextButton);
    calendarEl.appendChild(navDiv);


    const firstDayOfMonth = new Date(year, displayedMonth, 1).getDay(); // 0 (Dom) - 6 (Sab)
    const daysInMonth = new Date(year, displayedMonth + 1, 0).getDate();

    const grid = document.createElement('div');
    grid.className = 'calendar-grid';

    const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];
    weekDays.forEach(day => grid.innerHTML += `<div class='header-cell'>${day}</div>`);

    for (let i = 0; i < firstDayOfMonth; i++) {
        grid.innerHTML += `<div></div>`; 
    }
    
    const todayForComparison = new Date(); // Data atual para comparação (sem horas)
    todayForComparison.setHours(0,0,0,0);

    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(displayedMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const currentDateObj = new Date(year, displayedMonth, d);
        currentDateObj.setHours(0,0,0,0); // Para comparar apenas a data

        let hasAvailable = false;
        if (currentDateObj >= todayForComparison) { 
             hasAvailable = horarios.some(h => !currentAgendamentos[`${selectedCollaborator}_${dateStr}_${h}`]);
        }
       
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        if (currentDateObj < todayForComparison) { // Data passada
            dayCard.style.backgroundColor = '#dddddd';
            dayCard.style.cursor = 'not-allowed';
            dayCard.innerHTML = `${d}`;
        } else {
            dayCard.innerHTML = `${hasAvailable ? '' : '<div class="icon-red">🔴</div>'}${d}`;
            dayCard.onclick = () => openDay(dateStr);
        }
        grid.appendChild(dayCard);
    }
    calendarEl.appendChild(grid);
}

// NOVO: Função para mudar o mês/ano exibido
function changeMonthDisplay(offset) {
    displayedMonth += offset;
    if (displayedMonth > 11) {
        displayedMonth = 0;
        displayedYear++;
    } else if (displayedMonth < 0) {
        displayedMonth = 11;
        displayedYear--;
    }
    showMonth(); // Re-renderiza o calendário com o novo mês/ano
}


function showWeek() {
    clearScreensAndForm();
    const weekViewEl = document.getElementById('weekView');
    weekViewEl.innerHTML = '<h2>Próximos 5 Dias Úteis</h2>';
    weekViewEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const today = new Date();
    const weekDates = [];

    let currentDate = new Date(today);
    if (currentDate.getDay() === 0) { 
        currentDate.setDate(currentDate.getDate() + 1);
    } else if (currentDate.getDay() === 6) { 
        currentDate.setDate(currentDate.getDate() + 2);
    }

    for (let i = 0; i < 5; i++) { 
        while (currentDate.getDay() === 0 || currentDate.getDay() === 6) { 
            currentDate.setDate(currentDate.getDate() + 1);
        }
        const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
        const dayLabel = currentDate.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
        weekDates.push({ label: `${dayLabel} (${currentDate.getDate()}/${currentDate.getMonth()+1})`, dateStr });
        currentDate.setDate(currentDate.getDate() + 1);
    }

    const grid = document.createElement('div');
    grid.className = 'week-grid';

    weekDates.forEach(day => {
        const column = document.createElement('div');
        const header = document.createElement('div');
        header.className = 'header-cell';
        header.innerText = day.label;
        column.appendChild(header);

        let availableSlots = false;
        horarios.forEach(hora => {
            const key = `${selectedCollaborator}_${day.dateStr}_${hora}`;
            if (!currentAgendamentos[key]) {
                availableSlots = true;
                const btn = document.createElement('div');
                btn.className = 'hour';
                btn.innerText = hora;
                btn.onclick = () => selectHourAndShowForm(day.dateStr, hora);
                column.appendChild(btn);
            }
        });

        if (!availableSlots) {
            const noAvailable = document.createElement('div');
            noAvailable.className = 'no-available';
            noAvailable.innerHTML = '🔴'; 
            column.appendChild(noAvailable);
        }
        grid.appendChild(column);
    });
    weekViewEl.appendChild(grid);
}


function openDay(dateStr) { 
    clearScreensAndForm();
    const dayHoursEl = document.getElementById('dayHours');
    dayHoursEl.innerHTML = ''; 
    dayHoursEl.classList.remove('hidden');
    document.getElementById('backButton').classList.remove('hidden');

    const formattedDate = formatDateToBR(dateStr);
    dayHoursEl.innerHTML = `<h2>Horários para ${formattedDate}</h2>`;
    
    const container = document.createElement('div'); 
    container.className = 'day-hours-container';

    let available = false;
    const todayForComparison = new Date();
    todayForComparison.setHours(0,0,0,0);
    const dateObj = new Date(dateStr + "T00:00:00"); // Garante que é interpretado como local
    dateObj.setHours(0,0,0,0);


    if (dateObj < todayForComparison) {
         const pastDateMsg = document.createElement('div');
         pastDateMsg.className = 'no-available';
         pastDateMsg.innerText = 'Não é possível agendar em datas passadas.';
         container.appendChild(pastDateMsg);
    } else {
        horarios.forEach(hora => {
            const key = `${selectedCollaborator}_${dateStr}_${hora}`;
            if (!currentAgendamentos[key]) {
                available = true;
                const hourBtn = document.createElement('div');
                hourBtn.className = 'hour';
                hourBtn.innerText = hora;
                hourBtn.onclick = () => selectHourAndShowForm(dateStr, hora);
                container.appendChild(hourBtn);
            }
        });
    }

    if (!available && dateObj >= todayForComparison) {
        const noAvailable = document.createElement('div');
        noAvailable.className = 'no-available';
        noAvailable.innerText = '🔴 Sem horários disponíveis para este dia.';
        container.appendChild(noAvailable);
    }
    dayHoursEl.appendChild(container);

    const backBtnDiv = document.createElement('div');
    backBtnDiv.className = 'back-button'; 
    backBtnDiv.style.marginTop = '20px';
    const specificBackBtn = document.createElement('button');
    specificBackBtn.innerHTML = '⬅ Voltar para o Calendário Mensal';
    specificBackBtn.onclick = () => showMonth(); // MODIFICADO: Chama showMonth para voltar ao mês exibido
    backBtnDiv.appendChild(specificBackBtn);
    dayHoursEl.appendChild(backBtnDiv);
}


function selectHourAndShowForm(date, hour) {
    selectedDate = date; 
    selectedHour = hour;
    document.getElementById('form').style.display = 'flex';
    document.getElementById('dayHours').classList.add('hidden'); 
    document.getElementById('weekView').classList.add('hidden'); 
    document.getElementById('calendar').classList.add('hidden'); 
    document.getElementById('nome').focus();
}

async function book() {
    const nome = document.getElementById('nome').value.trim();
    const empreendimento = document.getElementById('empreendimento').value.trim();
    const local = document.getElementById('local').value.trim();
    const telefone = document.getElementById('telefone').value.trim();
    const observacoes = document.getElementById('observacoes').value.trim();

    if (!nome || !empreendimento || !local) {
        alert('Preencha os campos obrigatórios: Nome, Empreendimento e Local!');
        return;
    }

    const key = `${selectedCollaborator}_${selectedDate}_${selectedHour}`;
    await DataManager.addAgendamento(key, {
        nome,
        empreendimento,
        local,
        telefone,
        observacoes,
        status: "Agendado" 
    });

    alert(`Agendado para ${selectedCollaborator} em ${formatDateToBR(selectedDate)} às ${selectedHour} com sucesso!`);
    clearForm();
    resetAgendamentoView(); 
}

function clearForm() {
    const form = document.getElementById('form');
    form.style.display = 'none';
    document.getElementById('nome').value = ''; // MODIFICADO: reset manual dos campos
    document.getElementById('empreendimento').value = '';
    document.getElementById('local').value = '';
    document.getElementById('telefone').value = '';
    document.getElementById('observacoes').value = '';
}


function cancelForm() {
    clearForm();
    // MODIFICADO: Lógica de para onde voltar
    // Se selectedDate existe, significa que estávamos na visualização de dia ou semana
    // A navegação exata de volta é um pouco complexa de rastrear perfeitamente sem um histórico de estado.
    // Esta heurística tenta voltar para uma visualização razoável.
    if(selectedDate){ 
        // Se viemos de 'openDay', o `selectedDate` estará preenchido. `showMonth` voltará para o mês correto.
        // Se viemos de 'showWeek', o `selectedDate` também estará preenchido.
        // A forma mais simples é verificar qual tela estava visível antes do formulário.
        // No entanto, o `goBack` geral ou re-mostrar a seleção de mês/semana pode ser mais simples.
        
        // Vamos tentar reabrir a visualização de horários do dia se um dia foi selecionado,
        // ou o calendário mensal se nenhum horário específico foi selecionado antes do formulário.
        // A função `goBack()` agora lida melhor com isso se o formulário foi o último passo.
        // Se o usuário estava no calendário do mês, depois dia, depois formulário, `goBack()` deve funcionar.
        // Se estava na semana, depois formulário, `goBack()` deve funcionar.

        // A decisão de para onde voltar após cancelar o formulário é um pouco complexa
        // pois depende do fluxo anterior do usuário. O goBack() já tem uma lógica.
        // Uma alternativa seria forçar voltar para a seleção de tipo de visualização (mês/semana).
        clearScreensAndForm();
        document.getElementById('selector').classList.remove('hidden');
        document.getElementById('backButton').classList.remove('hidden');

    } else {
       goBack(); 
    }
    // Limpa selectedDate e selectedHour para não interferir na próxima seleção de data/hora
    selectedDate = '';
    selectedHour = '';
}


function clearScreensAndForm() {
    document.getElementById('calendar').classList.add('hidden');
    document.getElementById('dayHours').classList.add('hidden');
    document.getElementById('weekView').classList.add('hidden');
    clearForm();
}

// --- Funções de Relatório ---
async function loadReports() {
    await applyFilters(); 
    await updateStats();
}

async function applyFilters() {
    const colaboradorFilter = document.getElementById('filter-colaborador').value;
    let dataInicioFilter = document.getElementById('filter-data-inicio').value;
    let dataFimFilter = document.getElementById('filter-data-fim').value;
    const empreendimentoFilter = document.getElementById('filter-empreendimento').value.toLowerCase();

    let dados = await DataManager.getAllAgendamentosArray();

    dataInicioFilter = dataInicioFilter ? new Date(dataInicioFilter + 'T00:00:00Z') : null;
    dataFimFilter = dataFimFilter ? new Date(dataFimFilter + 'T23:59:59Z') : null; // MODIFICADO: para incluir o dia final inteiro


    if (colaboradorFilter) {
        dados = dados.filter(item => item.colaborador === colaboradorFilter);
    }
    if (dataInicioFilter) {
        dados = dados.filter(item => new Date(item.data + 'T00:00:00Z') >= dataInicioFilter);
    }
    if (dataFimFilter) {
        dados = dados.filter(item => new Date(item.data + 'T00:00:00Z') <= dataFimFilter);
    }
    if (empreendimentoFilter) {
        dados = dados.filter(item => item.empreendimento.toLowerCase().includes(empreendimentoFilter));
    }
    renderTable(dados);
}


function renderTable(dados) {
    const tbody = document.getElementById('reports-tbody');
    tbody.innerHTML = '';
    if (dados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666;">Nenhum agendamento encontrado para os filtros aplicados.</td></tr>';
        return;
    }
    dados.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${formatDateToBR(item.data)}</td>
            <td>${item.horario}</td>
            <td>${item.colaborador}</td>
            <td>${item.nome}</td>
            <td>${item.empreendimento}</td>
            <td>${item.local}</td>
            <td>${item.telefone || '-'}</td>
            <td>${item.observacoes || '-'}</td>
            <td>
                <button class="action-btn" onclick="removeAgendamento('${item.key}')">
                    Excluir
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function updateStats() {
    const dados = await DataManager.getAllAgendamentosArray();
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0]; 

    let startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1)); 
    startOfWeek.setHours(0, 0, 0, 0);

    let endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6); 
    endOfWeek.setHours(23, 59, 59, 999);
    
    const totalAgendamentos = dados.length;
    const agendamentosHoje = dados.filter(item => item.data === todayStr).length;
    const agendamentosSemana = dados.filter(item => {
        const itemDate = new Date(item.data + "T00:00:00"); 
        return itemDate >= startOfWeek && itemDate <= endOfWeek;
    }).length;

    const agendamentosPorColaborador = dados.reduce((acc, item) => {
        acc[item.colaborador] = (acc[item.colaborador] || 0) + 1;
        return acc;
    }, {});

    const statsContainer = document.getElementById('stats-container');
    statsContainer.innerHTML = `
        <div class="stat-card">
            <div class="stat-number">${totalAgendamentos}</div>
            <div class="stat-label">Total Agendados</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${agendamentosHoje}</div>
            <div class="stat-label">Agendamentos Hoje</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${agendamentosSemana}</div>
            <div class="stat-label">Esta Semana (Seg-Dom)</div>
        </div>
    `;
    Object.entries(agendamentosPorColaborador).forEach(([colaborador, count]) => {
        const statCard = document.createElement('div');
        statCard.className = 'stat-card';
        statCard.innerHTML = `
            <div class="stat-number">${count}</div>
            <div class="stat-label">${colaborador}</div>
        `;
        statsContainer.appendChild(statCard);
    });
     if (Object.keys(agendamentosPorColaborador).length === 0 && totalAgendamentos > 0) {
        statsContainer.innerHTML += `<div class="stat-card"><div class="stat-label">Nenhum colaborador com agendamentos.</div></div>`;
    }
}


async function removeAgendamento(key) {
    if (confirm('Tem certeza que deseja excluir este agendamento?')) {
        await DataManager.removeAgendamento(key);
        await loadReports(); 
        alert('Agendamento excluído com sucesso!');
    }
}

async function exportToCSV() {
    const dados = await DataManager.getAllAgendamentosArray();
    if (dados.length === 0) {
        alert('Não há dados para exportar!');
        return;
    }
    // Colaboradores, nome, data, hora, empreendimento e local (campos solicitados)
    // Adicionando Telefone e Observações também, pois são úteis.
    const headers = ['Colaborador', 'Nome Responsável', 'Data', 'Horário', 'Empreendimento', 'Local', 'Telefone', 'Observações'];
    
    const csvRows = dados.map(item => [
        `"${item.colaborador || ''}"`,
        `"${item.nome || ''}"`,
        formatDateToBR(item.data), // Data já está no formato correto para CSV
        `"${item.horario || ''}"`,
        `"${item.empreendimento || ''}"`,
        `"${item.local || ''}"`,
        `"${item.telefone || ''}"`,
        `"${(item.observacoes || '').replace(/"/g, '""')}"` // Escapa aspas duplas dentro do campo
    ].join(','));

    const csvContent = [headers.join(','), ...csvRows].join('\n');
    downloadFile(csvContent, 'agendamentos_vistorias.csv', 'text/csv;charset=utf-8;');
}

function exportToPDF() {
    alert('Funcionalidade de exportação para PDF ainda não implementada. Considere usar a impressão do navegador (Ctrl+P) e "Salvar como PDF".');
    // Para uma implementação real com jsPDF:
    // 1. Inclua a biblioteca jsPDF no seu HTML: <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    //                                       <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    // 2. Descomente e ajuste o código abaixo:
    /*
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    DataManager.getAllAgendamentosArray().then(dados => {
        if (dados.length === 0) {
            alert('Não há dados para exportar para PDF!');
            return;
        }

        doc.text("Relatório de Agendamentos de Vistorias", 14, 16);
        
        const tableColumn = ["Data", "Horário", "Colaborador", "Responsável", "Empreendimento", "Local"];
        const tableRows = [];

        dados.forEach(item => {
            const agendamentoData = [
                formatDateToBR(item.data),
                item.horario,
                item.colaborador,
                item.nome,
                item.empreendimento,
                item.local
                // Adicione mais campos se desejar (telefone, observações)
            ];
            tableRows.push(agendamentoData);
        });

        doc.autoTable(tableColumn, tableRows, { startY: 20 });
        doc.save('agendamentos_vistorias.pdf');
        alert('PDF gerado com sucesso (se os dados existirem).');
    });
    */
}


async function clearAllData() {
    if (confirm('ATENÇÃO: Isto irá excluir TODOS os agendamentos armazenados no seu navegador. Tem certeza?')) {
        await DataManager.saveAgendamentos({});
        currentAgendamentos = {}; 
        await loadReports();
        alert('Todos os dados foram excluídos!');
    }
}

function downloadFile(content, filename, contentType) {
    const blob = new Blob(["\uFEFF" + content], { type: contentType }); // NOVO: \uFEFF para BOM UTF-8 (Excel)
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function formatDateToBR(dateStr) { 
    if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr; 
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
}

function formatDateToISO(dateStr) { 
    if (!dateStr || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return dateStr;
    const [day, month, year] = dateStr.split('/');
    return `${year}-${month}-${day}`;
}

document.addEventListener('DOMContentLoaded', initializeApp);

</script>
</body>
</html>
